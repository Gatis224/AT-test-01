<!DOCTYPE html>
<html lang="lv">
   <head>
      <meta charset="UTF-8" />
      <title>PDF uz Excel caur n8n Proxy</title>
      <style>
         body {
         font-family: Arial, sans-serif;
         margin: 100px auto;
         text-align: center;
         max-width: 500px;
         }
         input, button {
         margin-top: 20px;
         font-size: 16px;
         }
         .custom-btn {
         display: inline-block;
         padding: 10px 20px;
         background-color: #007bff;
         color: white;
         font-size: 16px;
         cursor: pointer;
         border: none;
         border-radius: 5px;
         margin-top: 20px;
         }
         .custom-btn:disabled {
         background-color: #a0a0a0;
         cursor: not-allowed;
         }
         /* Spinner stils */
         .spinner {
         border: 4px solid #f3f3f3;
         border-top: 4px solid #007bff;
         border-radius: 50%;
         width: 24px;
         height: 24px;
         animation: spin 1s linear infinite;
         display: inline-block;
         vertical-align: middle;
         margin-left: 10px;
         }
         @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
         }
         /* Check mark stils */
         .checkmark {
         display: inline-block;
         color: green;
         font-size: 24px;
         vertical-align: middle;
         margin-left: 10px;
         }
         #statusText {
         margin-top: 20px;
         font-style: italic;
         display: block;
         }
      </style>
   </head>
   <body>
      <h2>Augšupielādē PDF un saņem Excel failu</h2>
      <input type="file" id="pdfFile" accept="application/pdf" style="display:none;" />
      <label for="pdfFile" id="fileLabel" class="custom-btn">Izvēlēties PDF failu</label>
      <span id="fileName" style="margin-left: 10px; font-style: italic;"></span>
      <br/>
      <br/>
      <button class="custom-btn" onclick="uploadFile()">Nosūtīt uz apstrādi</button>
      <br/>
      <!-- Teksta lauks faila nosaukumam -->
      <input type="text" id="saveFileName" style="margin-top:10px; font-size:16px; padding:5px;" placeholder="Faila nosaukums" />
      <button id="downloadBtn" class="custom-btn" disabled onclick="downloadFile()">Lejupielādēt Excel</button>
      <span id="statusText"></span>
      <script>
         let savedExcelBlob = null;
         const statusText = document.getElementById('statusText');
         const saveFileNameInput = document.getElementById('saveFileName');
         const fileInput = document.getElementById('pdfFile');
         const fileNameSpan = document.getElementById('fileName');

         fileInput.addEventListener('change', () => {
           if (fileInput.files.length > 0) {
             const pdfName = fileInput.files[0].name.replace(/\.pdf$/i, '');
             fileNameSpan.textContent = fileInput.files[0].name;
             // Default faila nosaukums Excel saglabāšanai
             saveFileNameInput.value = pdfName + ".xlsx";
           } else {
             fileNameSpan.textContent = "";
             saveFileNameInput.value = "";
           }
         });

         async function uploadFile() {
           if (!fileInput.files.length) {
             alert("Lūdzu izvēlies PDF failu!");
             return;
           }

           const formData = new FormData();
           formData.append("file", fileInput.files[0]);

           // Parādām spinner
           statusText.innerHTML = 'Fails tiek apstrādāts... <span class="spinner"></span>';
           savedExcelBlob = null;
           document.getElementById('downloadBtn').disabled = true;

           try {
             const response = await fetch("https://at-test-01.onrender.com/upload", {
               method: "POST",
               body: formData
             });

             if (!response.ok) {
               const text = await response.text();
               throw new Error("Kļūda: " + text);
             }

             savedExcelBlob = await response.blob();
             document.getElementById('downloadBtn').disabled = false;

             statusText.innerHTML = 'Fails ir gatavs <span class="checkmark">&#10003;</span>';
           } catch (err) {
             statusText.textContent = "Kļūda: " + err.message;
           }
         }

         function downloadFile() {
           if (!savedExcelBlob) return;

           // Lietotāja ievadītais faila nosaukums
           let fileName = saveFileNameInput.value.trim();
           if (!fileName) fileName = "rezultats.xlsx";

           const url = URL.createObjectURL(savedExcelBlob);
           const a = document.createElement("a");
           a.href = url;
           a.download = fileName;
           document.body.appendChild(a);
           a.click();
           a.remove();
           URL.revokeObjectURL(url);

           // Atiestata statusu un pogu
           savedExcelBlob = null;
           document.getElementById('downloadBtn').disabled = true;
           statusText.textContent = "";
           fileNameSpan.textContent = "";
           saveFileNameInput.value = "";
         }
      </script>
   </body>
</html>